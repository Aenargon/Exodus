<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EXODUS - METASCANNER V9.3</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --crt-green: #2ecc71; --cold-blue: #a0d2eb; --danger-red: #ff3e3e; --bg: #050805; }
        body { background: var(--bg); color: var(--crt-green); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; text-transform: uppercase; }
        .crt-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 5000; }
        #bg-char { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; opacity: 0; z-index: -1; filter: grayscale(100%); transition: opacity 1s; }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 5, 0, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 20px; box-sizing: border-box; text-align: center; }
        #ui-wrapper { display: none; flex-direction: column; height: 100vh; position: relative; }
        #header { height: 50px; border-bottom: 1px solid var(--crt-green); padding: 0 15px; background: rgba(0,20,0,0.9); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #camera-container { position: relative; height: 40vh; overflow: hidden; background: #000; border-bottom: 2px solid #111; display: flex; align-items: center; justify-content: center; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #scan-line { position: absolute; width: 100%; height: 5px; background: var(--crt-green); top: -10px; display: none; box-shadow: 0 0 20px var(--crt-green); z-index: 1000; }
        @keyframes moveScan { 0% { top: 0%; } 100% { top: 100%; } }
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; background: #000; flex-grow: 1; align-content: start; }
        .scan-btn-container { display: flex; flex-direction: column; align-items: center; }
        .last-res { font-size: 12px; margin-top: 5px; color: var(--cold-blue); font-weight: bold; }
        #btn-bio { grid-column: span 3; display:none; background: #004466; color: #fff; border: 2px solid #00ffff; font-weight: bold; padding: 18px; margin-bottom: 10px; }
        button { background: #0d1a0d; color: var(--crt-green); border: 1px solid var(--crt-green); padding: 15px 5px; font-family: inherit; font-size: 9px; cursor: pointer; border-radius: 4px; width: 100%; }
        button:disabled { opacity: 0.3; border-color: #333; color: #555; cursor: not-allowed; }
        .btn-main { padding: 20px 40px; font-size: 1.1rem; border-color: #00ffff; color: #00ffff; margin: 10px 0; width: 80%; }
        input { background: black; color: var(--crt-green); border: 1px solid var(--crt-green); padding: 15px; text-align: center; font-size: 1.2rem; width: 85%; margin: 10px 0; }
    </style>
</head>
<body>

<div class="crt-overlay"></div>
<img id="bg-char" src="" alt="">

<div id="start-screen" class="modal" style="display: flex;">
    <h1 style="color: #00ffff; letter-spacing: 5px;">EXODUS CORE</h1>
    <p>METASCANNER V9.3</p>
    <button onclick="startNewGame()" class="btn-main" id="btn-start-mision">INICIAR MISIÓN</button>
    <button id="btn-resume" onclick="goToHub()" style="display:none; color: var(--cold-blue); border-color: var(--cold-blue); padding: 15px 30px; margin-top: 10px; width: 80%;">REANUDAR MISIÓN</button>
</div>

<div id="setup-screen" class="modal">
    <h2 style="color: var(--cold-blue)">CALIBRACIÓN</h2>
    <p>Detectando frecuencias QR...</p>
    <div id="setup-progress" style="font-size: 6rem; color: white;">0/3</div>
</div>

<div id="reg-screen" class="modal">
    <h2 id="reg-title">REGISTRO</h2>
    <div id="reg-step-1">
        <input type="text" id="reg-name" placeholder="NOMBRE..." autocomplete="off">
        <button onclick="saveRegName()" style="width: 100%; font-size: 1.2rem; padding: 20px; margin-top:10px;">VINCULAR</button>
    </div>
    <div id="reg-step-2" style="display:none;">
        <p style="color: var(--cold-blue);">ESCANEA TU CARTA</p>
        <div style="border: 1px dashed var(--cold-blue); padding: 40px; margin-top: 20px;">VINCULANDO...</div>
    </div>
</div>

<div id="hub-screen" class="modal">
    <button onclick="resetGamePrompt()" style="position: absolute; top: 15px; color: var(--danger-red); border: 1px solid var(--danger-red); font-size: 9px; padding: 8px;">REINICIAR NÚCLEO</button>
    <h2 style="color: #00ffff; margin-top: 40px;">ACCESO</h2>
    <button id="btn-hub-pA" onclick="loginPlayer('pA')" style="width: 280px; padding: 25px; margin-bottom: 15px;">---</button>
    <button id="btn-hub-pB" onclick="loginPlayer('pB')" style="width: 280px; padding: 25px;">---</button>
</div>

<div id="ui-wrapper">
    <div id="header">
        <button onclick="logout()" style="width: 80px; font-size: 8px; color: var(--cold-blue);">LOGOUT</button>
        <span id="player-display">---</span>
        <button onclick="openBypass()" style="width: 80px; font-size: 8px; color: var(--cold-blue);">BYPASS</button>
    </div>
    <div id="camera-container">
        <div id="scan-line"></div>
        <video id="video" playsinline></video>
        <canvas id="canvas" style="display:none"></canvas>
        <div id="res-modal" class="modal">
            <h1 id="res-perc" style="font-size: 5rem; color: white;">0%</h1>
            <p id="res-msg">ANALIZANDO...</p>
            <button onclick="closeModal('res-modal')" style="width: 180px; padding: 15px; margin-top: 20px;">CERRAR</button>
        </div>
    </div>
    <div id="terminal">> NÚCLEO EXODUS ONLINE</div>
    <div class="btn-group">
        <button id="btn-bio" onclick="playVideo()">BIO-LOG ANIMADO</button>
        <div class="scan-btn-container">
            <button id="btn-scan-NEURONAL" onclick="runScan('NEURONAL')">SCAN NEURONAL</button>
            <div id="val-NEURONAL" class="last-res">--%</div>
        </div>
        <div class="scan-btn-container">
            <button id="btn-scan-EM" onclick="runScan('EM')">SCAN ELECTROMAG.</button>
            <div id="val-EM" class="last-res">--%</div>
        </div>
        <div class="scan-btn-container">
            <button id="btn-scan-MUTAGENO" onclick="runScan('MUTAGENO')">SCAN MUTÁGENO</button>
            <div id="val-MUTAGENO" class="last-res">--%</div>
        </div>
    </div>
</div>

<div id="bypass-screen" class="modal">
    <h2 style="color: var(--cold-blue)">HACK</h2>
    <div id="mm-display" style="font-size: 2.5rem; border: 1px solid var(--cold-blue); padding: 15px; margin: 10px;">---</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
        <button onclick="pressNum('1')">1</button><button onclick="pressNum('2')">2</button><button onclick="pressNum('3')">3</button>
        <button onclick="pressNum('4')">4</button><button onclick="pressNum('5')">5</button><button onclick="pressNum('6')">6</button>
        <button onclick="pressNum('7')">7</button><button onclick="pressNum('8')">8</button><button onclick="pressNum('9')">9</button>
        <button onclick="clearNum()" style="color: var(--danger-red);">X</button><button onclick="pressNum('0')">0</button><button onclick="checkBypass()" style="color: #00ff00;">OK</button>
    </div>
    <button onclick="closeModal('bypass-screen')" style="margin-top: 15px;">SALIR</button>
</div>

<script>
    let isProcessing = false;
    let currentRegPlayer = 'pA';
    let activePlayer = null;
    let consoles = [];
    let sessionScanned = false;
    
    const sndScan = new Audio('media/audio/scan.mp3');
    const sndSuccess = new Audio('media/audio/scan_match.mp3');
    const sndFail = new Audio('media/audio/scan_fail.mp3');

    let game = JSON.parse(localStorage.getItem('exodus_v9')) || {
        pass: [],
        pA: { name: "", char: "", role: "", scans: { NEURONAL: {count:0, val:null, blocked:false}, EM: {count:0, val:null, blocked:false}, MUTAGENO: {count:0, val:null, blocked:false} }},
        pB: { name: "", char: "", role: "", scans: { NEURONAL: {count:0, val:null, blocked:false}, EM: {count:0, val:null, blocked:false}, MUTAGENO: {count:0, val:null, blocked:false} }}
    };

    const v = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => { 
        v.srcObject = s; v.play(); requestAnimationFrame(tick); 
    });

    if(game.pA.name && game.pB.name) {
        document.getElementById('btn-resume').style.display = 'block';
        document.getElementById('btn-start-mision').innerText = "NUEVA MISIÓN";
    }

    function tick() {
        if (v.readyState === v.HAVE_ENOUGH_DATA && !isProcessing) {
            canvas.height = v.videoHeight; canvas.width = v.videoWidth;
            ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code && code.data.toLowerCase().startsWith("acheron_")) handleQR(code.data.toLowerCase());
        }
        requestAnimationFrame(tick);
    }

    function handleQR(data) {
        if (activePlayer) {
            let scChar = data.replace("acheron_char_", "");
            if (data.includes("char_") && scChar !== game[activePlayer].char) {
                isProcessing = true; alert("⚠️ ERROR IDENTIDAD"); setTimeout(() => isProcessing = false, 3000);
            }
            return; 
        }
        isProcessing = true; 
        if (game.pass.length < 3) {
            if (data.includes("cons_") && !consoles.includes(data)) {
                consoles.push(data);
                document.getElementById('setup-progress').innerText = consoles.length + "/3";
                if (consoles.length === 3) {
                    game.pass = consoles.map(c => c.split('_').pop());
                    save(); setTimeout(() => { document.getElementById('setup-screen').style.display = 'none'; showRegistration(); }, 800);
                }
            }
        }
        else if (document.getElementById('reg-step-2').style.display === 'flex' && data.includes("char_")) {
            let scChar = data.replace("acheron_char_", "");
            if (game.pA.char === scChar || game.pB.char === scChar) { alert("PERSONAJE YA ASIGNADO"); } 
            else {
                game[currentRegPlayer].char = scChar;
                game[currentRegPlayer].role = ['HUMANO', 'CYBORG', 'ADAPTOID'][Math.floor(Math.random()*3)];
                save();
                if (currentRegPlayer === 'pA') { currentRegPlayer = 'pB'; setTimeout(showRegistration, 500); } 
                else { setTimeout(goToHub, 500); }
            }
        }
        setTimeout(() => { isProcessing = false; }, 2000);
    }

    function startNewGame() {
        if(game.pA.name && !confirm("¿BORRAR DATOS Y REINICIAR?")) return;
        localStorage.removeItem('exodus_v9');
        game = { pass: [], pA: { name: "", char: "", role: "", scans: { NEURONAL: {count:0, val:null, blocked:false}, EM: {count:0, val:null, blocked:false}, MUTAGENO: {count:0, val:null, blocked:false} }}, pB: { name: "", char: "", role: "", scans: { NEURONAL: {count:0, val:null, blocked:false}, EM: {count:0, val:null, blocked:false}, MUTAGENO: {count:0, val:null, blocked:false} }} };
        consoles = []; sessionScanned = false;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'flex';
        document.getElementById('setup-progress').innerText = "0/3";
        isProcessing = false;
    }

    function showRegistration() {
        document.getElementById('reg-screen').style.display = 'flex';
        document.getElementById('reg-title').innerText = "REGISTRO: " + (currentRegPlayer === 'pA' ? "JUGADOR A" : "JUGADOR B");
        document.getElementById('reg-step-1').style.display = 'block';
        document.getElementById('reg-step-2').style.display = 'none';
    }

    function saveRegName() {
        let n = document.getElementById('reg-name').value;
        if(n) { game[currentRegPlayer].name = n.toUpperCase(); document.getElementById('reg-step-1').style.display = 'none'; document.getElementById('reg-step-2').style.display = 'flex'; isProcessing = false; }
    }

    function goToHub() {
        document.querySelectorAll('.modal').forEach(m => m.style.display='none');
        document.getElementById('hub-screen').style.display = 'flex';
        document.getElementById('btn-hub-pA').innerText = game.pA.name || "---";
        document.getElementById('btn-hub-pB').innerText = game.pB.name || "---";
    }

    function loginPlayer(p) {
        activePlayer = p; sessionScanned = false;
        document.getElementById('hub-screen').style.display = 'none';
        document.getElementById('ui-wrapper').style.display = 'flex';
        document.getElementById('player-display').innerText = game[p].name;
        document.getElementById('bg-char').src = `media/images/${game[p].char}.jpg`;
        document.getElementById('bg-char').style.opacity = "0.2";
        document.getElementById('btn-bio').style.display = 'block';
        updateScanUI();
    }

    function runScan(mode) {
        if (sessionScanned) return;
        let pData = game[activePlayer].scans[mode];
        if (pData.blocked) return;
        sndScan.play();
        const line = document.getElementById('scan-line');
        line.style.display = 'block';
        line.style.animation = 'moveScan 1.5s linear forwards';
        setTimeout(() => {
            line.style.display = 'none'; pData.count++; sessionScanned = true;
            let isCorrect = (mode === 'NEURONAL' && game[activePlayer].role === 'HUMANO') || (mode === 'EM' && game[activePlayer].role === 'CYBORG') || (mode === 'MUTAGENO' && game[activePlayer].role === 'ADAPTOID');
            let res = 0;
            if (pData.count === 1) {
                if (isCorrect) { res = Math.floor(Math.random() * 15) + 70; } 
                else { res = Math.floor(Math.random() * 15); pData.blocked = true; sndFail.play(); }
            } else {
                if (isCorrect) { res = 100; sndSuccess.play(); document.getElementById('res-msg').innerText = "CONFIRMADO"; } 
                else { res = Math.floor(Math.random() * 10); sndFail.play(); }
                pData.blocked = true;
            }
            pData.val = res; updateScanUI();
            document.getElementById('res-perc').innerText = res + "%";
            document.getElementById('res-modal').style.display = 'flex';
            save();
        }, 1500);
    }

    function updateScanUI() {
        ['NEURONAL', 'EM', 'MUTAGENO'].forEach(m => {
            let d = game[activePlayer].scans[m];
            document.getElementById('val-' + m).innerText = d.val !== null ? d.val + "%" : "--%";
            document.getElementById('btn-scan-' + m).disabled = d.blocked || sessionScanned;
        });
    }

    function logout() { activePlayer = null; document.getElementById('bg-char').style.opacity = "0"; goToHub(); }
    function resetGamePrompt() { startNewGame(); }
    function save() { localStorage.setItem('exodus_v9', JSON.stringify(game)); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.getElementById('res-msg').innerText = "ANALIZANDO..."; }
    function playVideo() { window.open(`media/videos/${game[activePlayer].char}.mp4`, '_blank'); }
    function openBypass() { document.getElementById('bypass-screen').style.display = 'flex'; }
    function pressNum(n) { if(guess.length < 3) { guess += n; document.getElementById('mm-display').innerText = guess; } }
    function clearNum() { guess = ""; document.getElementById('mm-display').innerText = "---"; }
    let guess = "";
    function checkBypass() {
        if(guess.length < 3) return;
        let s = game.pass, g = guess.split(""), pos = 0, num = 0, sC = [...s], gC = [...g];
        for(let i=0; i<3; i++) { if(gC[i] === sC[i]) { pos++; sC[i] = null; gC[i] = "X"; } }
        for(let i=0; i<3; i++) { if(gC[i] !== "X" && sC.includes(gC[i])) { num++; sC[sC.indexOf(gC[i])] = null; } }
        alert(`BIEN: ${pos} | MAL POS: ${num}`); clearNum();
    }
</script>
</body>
</html>
