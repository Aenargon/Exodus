<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACHERON CORE - V7.0</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --crt-green: #2ecc71; --cold-blue: #a0d2eb; --danger-red: #ff3e3e; --bg: #050805; }
        body { background: var(--bg); color: var(--crt-green); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; text-transform: uppercase; font-size: 12px; }
        .crt-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 5000; }
        #ui-wrapper { display: flex; flex-direction: column; height: 100vh; position: relative; }
        #header { border-bottom: 1px solid var(--crt-green); padding: 10px; text-align: center; background: rgba(0,20,0,0.9); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        #camera-container { position: relative; flex-grow: 1; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 15, 0, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 20px; box-sizing: border-box; }
        #setup-screen { display: flex; } 
        #terminal-output { height: 60px; background: #000; border-top: 1px solid var(--crt-green); padding: 10px; font-size: 10px; color: #7f8c8d; }
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: #000; z-index: 100; }
        button { background: #0d1a0d; color: var(--crt-green); border: 1px solid var(--crt-green); padding: 15px 5px; font-family: inherit; font-size: 10px; cursor: pointer; }
        .btn-danger { border-color: var(--danger-red); color: var(--danger-red); }
        .btn-blue { border-color: var(--cold-blue); color: var(--cold-blue); display: none; grid-column: span 3; }
        #scan-line { position: absolute; width: 100%; height: 2px; background: var(--cold-blue); top: 0; display: none; box-shadow: 0 0 10px var(--cold-blue); z-index: 100; }
        @keyframes moveScan { from { top: 0; } to { top: 100%; } }
        .reset-btn { background: transparent; border: 1px solid #444; color: #aaa; padding: 5px 10px; font-size: 10px; z-index: 4000; }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>

    <div id="setup-screen" class="modal">
        <h2 style="color: var(--cold-blue)">INICIALIZACIÓN</h2>
        <p style="text-align:center">Escanea 3 QRs de Consola</p>
        <div id="setup-progress" style="font-size: 4rem; margin: 10px; color: white;">0 / 3</div>
        <div id="setup-log" style="color: var(--crt-green); font-size: 10px;">[ BUSCANDO SEÑAL... ]</div>
        <button id="btn-start" onclick="finishSetup()" style="display:none; width: 220px; background: var(--crt-green); color: #000; margin-bottom: 10px;">ACCEDER AL PUENTE</button>
        <button onclick="finishSetup()" style="border: 1px solid #444; color:#666; padding: 10px; font-size:8px;">[ MODO DEBUG / SALTAR ]</button>
    </div>

    <div id="ui-wrapper">
        <div id="header">
            <button class="reset-btn" onclick="hardReset()">RESET NAVE</button>
            <span>ACHERON v7.0 // JUGADOR:<span id="curr-p">A</span></span>
        </div>

        <div id="camera-container">
            <div id="scan-line"></div>
            <video id="video" playsinline></video>
            <canvas id="canvas" style="display:none"></canvas>

            <div id="res-modal" class="modal">
                <h1 id="res-perc" style="font-size: 4rem; margin: 0;">0%</h1>
                <h3 id="res-type">ESCANEO</h3>
                <p id="res-msg"></p>
                <button onclick="closeModal('res-modal')" style="width: 150px">CERRAR</button>
            </div>

            <div id="vid-modal" class="modal">
                <video id="p-video" style="width: 100%; max-height: 70%; border: 1px solid var(--cold-blue);"></video>
                <button onclick="stopVideo()" style="margin-top: 20px; width: 150px">SALIR</button>
            </div>
        </div>

        <div id="terminal-output">> SISTEMA ONLINE. ESCANEE IDENTIFICACIÓN.</div>

        <div class="btn-group">
            <button onclick="setMode('NEURONAL')">SCAN NEURONAL</button>
            <button onclick="setMode('EM')">SCAN ELECTROMAG.</button>
            <button onclick="setMode('MUTAGENO')">SCAN MUTÁGENO</button>
            <button id="btn-bio" class="btn-blue" onclick="playBioLog()">VER BIO-LOG (MP4)</button>
            <button onclick="nextTurn()" class="btn-danger" style="grid-column: span 3;">FINALIZAR TURNO</button>
        </div>
    </div>

<script>
    let setupDone = false;
    let scanMode = 'ID';
    let isProcessing = false;
    let consolesFound = [];
    
    let game = JSON.parse(localStorage.getItem('acheron_v7')) || {
        round: 1, turn: 'A', pA: { role: null, char: null, scans: {} }, pB: { role: null, char: null, scans: {} }, pass: []
    };

    const v = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
        v.srcObject = stream; v.play(); requestAnimationFrame(tick);
    });

    function tick() {
        if (v.readyState === v.HAVE_ENOUGH_DATA && !isProcessing) {
            canvas.height = v.videoHeight; canvas.width = v.videoWidth;
            ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code && code.data.toLowerCase().startsWith("acheron_")) {
                handleQR(code.data.toLowerCase());
            }
        }
        requestAnimationFrame(tick);
    }

    function handleQR(data) {
        isProcessing = true;
        
        // SETUP
        if (!setupDone) {
            if (data.includes("cons_") && !consolesFound.includes(data)) {
                consolesFound.push(data);
                document.getElementById('setup-progress').innerText = consolesFound.length + " / 3";
                if (consolesFound.length === 3) {
                    game.pass = consolesFound;
                    document.getElementById('btn-start').style.display = 'block';
                }
            }
            setTimeout(() => { isProcessing = false; }, 1500);
            return;
        }

        // PERSONAJE
        if (data.includes("char_")) {
            let p = game.turn === 'A' ? game.pA : game.pB;
            // Extraemos el nombre (ej: medic_man_001)
            p.char = data.replace("acheron_char_", "").trim();
            document.getElementById('terminal-output').innerText = "> RECONOCIDO: " + p.char;
            document.getElementById('btn-bio').style.display = 'block';
            if (!p.role) assignRole(p);
            if (scanMode !== 'ID') runAnalysis(p);
            else setTimeout(() => { isProcessing = false; }, 1500);
        }
    }

    function assignRole(player) {
        const other = game.turn === 'A' ? game.pB : game.pA;
        let options = ['HUMANO', 'CYBORG', 'ADAPTOID'];
        if (other.role === 'HUMANO') options = ['CYBORG', 'ADAPTOID'];
        else if (other.role === 'ADAPTOID') options = ['HUMANO', 'CYBORG'];
        player.role = options[Math.floor(Math.random() * options.length)];
        save();
    }

    function runAnalysis(player) {
        const line = document.getElementById('scan-line');
        line.style.display = 'block';
        line.style.animation = 'moveScan 2s linear infinite';
        setTimeout(() => {
            line.style.display = 'none';
            document.getElementById('res-modal').style.display = 'flex';
            let count = player.scans[scanMode] || 0;
            let match = (scanMode === 'NEURONAL' && player.role === 'HUMANO') || 
                        (scanMode === 'EM' && player.role === 'CYBORG') || 
                        (scanMode === 'MUTAGENO' && player.role === 'ADAPTOID');
            let prob = count === 0 ? (match ? r(50,75) : r(0,5)) : (match ? r(90,99) : r(5,15));
            document.getElementById('res-perc').innerText = prob + "%";
            document.getElementById('res-msg').innerText = prob > 80 ? "FIRMA POSITIVA" : "DATOS INSUFICIENTES";
            player.scans[scanMode] = count + 1;
            save();
        }, 2000);
    }

    function playBioLog() {
        let p = game.turn === 'A' ? game.pA : game.pB;
        if (!p.char) return;
        const vid = document.getElementById('p-video');
        // RUTA IMPECABLE
        vid.src = `media/videos/${p.char}.mp4`;
        document.getElementById('vid-modal').style.display = 'flex';
        vid.load();
        vid.play().catch(err => alert("Error cargando: media/videos/" + p.char + ".mp4"));
    }

    function stopVideo() { document.getElementById('p-video').pause(); closeModal('vid-modal'); }
    function nextTurn() {
        game.turn = game.turn === 'A' ? 'B' : 'A';
        document.getElementById('curr-p').innerText = game.turn;
        document.getElementById('btn-bio').style.display = 'none';
        save();
        alert("TURNO DEL JUGADOR " + game.turn);
    }
    function setMode(m) { scanMode = m; document.getElementById('terminal-output').innerText = "> MODO: " + m; }
    function finishSetup() { setupDone = true; document.getElementById('setup-screen').style.display = 'none'; save(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; isProcessing = false; scanMode = 'ID'; }
    function save() { localStorage.setItem('acheron_v7', JSON.stringify(game)); }
    function r(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
    function hardReset() { if(confirm("¿REINICIAR SISTEMAS?")) { localStorage.removeItem('acheron_v7'); location.reload(); } }

    if (game.pass.length === 3) finishSetup();
</script>
</body>
</html>
