<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACHERON CORE - V8.0</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --crt-green: #2ecc71; --cold-blue: #a0d2eb; --danger-red: #ff3e3e; --bg: #050805; }
        body { background: var(--bg); color: var(--crt-green); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; text-transform: uppercase; font-size: 12px; }
        
        .crt-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 5000; }
        
        #ui-wrapper { display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* Imagen de fondo de personaje */
        #bg-char { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; opacity: 0.15; z-index: -1; filter: grayscale(100%) contrast(150%); }

        #header { border-bottom: 1px solid var(--crt-green); padding: 10px; text-align: center; background: rgba(0,20,0,0.9); display: flex; justify-content: space-between; align-items: center; }
        
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 10, 0, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 20px; box-sizing: border-box; }
        
        /* Teclado Mastermind */
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .num-btn { padding: 15px; border: 1px solid var(--cold-blue); color: var(--cold-blue); background: transparent; font-size: 1.2rem; }
        
        #terminal-output { height: 50px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--crt-green); padding: 10px; font-size: 10px; color: #7f8c8d; }
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: #000; }
        button { background: #0d1a0d; color: var(--crt-green); border: 1px solid var(--crt-green); padding: 12px 5px; font-family: inherit; font-size: 9px; cursor: pointer; }
        .btn-blue { border-color: var(--cold-blue); color: var(--cold-blue); }
        
        #scan-line { position: absolute; width: 100%; height: 3px; background: var(--crt-green); top: 0; display: none; box-shadow: 0 0 15px var(--crt-green); z-index: 100; }
        @keyframes moveScan { from { top: 0; } to { top: 100%; } }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    <img id="bg-char" src="" alt="">

  <div id="start-screen" class="modal" style="display: flex;">
        <h1 style="color: var(--crt-green); letter-spacing: 5px;">ACHERON CORE</h1>
        <p>SISTEMA OPERATIVO DE EMERGENCIA</p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 50px;">
            <button onclick="startNewGame()" style="padding: 20px 40px; font-size: 1.2rem;">INICIAR NUEVA MISIÓN</button>
            <button onclick="resumeGame()" id="btn-resume" style="display:none; border-color: var(--cold-blue); color: var(--cold-blue); padding: 10px;">REANUDAR CONEXIÓN</button>
        </div>
    </div>

    <div id="setup-screen" class="modal">
        <h2 style="color: var(--cold-blue)">CONFIGURACIÓN DE PUENTE</h2>
        <p>Escanea 3 Consolas para generar clave</p>
        <div id="setup-progress" style="font-size: 4rem; color: white;">0/3</div>
        <button id="btn-start-game" onclick="showLogin()" style="display:none; background: var(--crt-green); color:black; padding: 15px 30px;">ACCEDER AL NÚCLEO</button>
    </div>

    <div id="login-screen" class="modal">
        <h2 id="login-title">IDENTIFÍQUESE</h2>
        <div id="player-selector">
            <button onclick="selectPlayer('A')">JUGADOR A</button>
            <button onclick="selectPlayer('B')">JUGADOR B</button>
        </div>
        <div id="name-input-zone" style="display:none; text-align: center;">
            <input type="text" id="player-name-field" placeholder="INTRODUZCA NOMBRE" style="background: black; color: var(--crt-green); border: 1px solid var(--crt-green); padding: 10px; text-align: center;">
            <button onclick="saveName()" style="margin-top: 10px; display: block; width: 100%;">REGISTRAR EN MANIFIESTO</button>
        </div>
        <div id="verify-zone" style="display:none; text-align: center;">
            <p style="color: var(--cold-blue);">ESCANEE CARTA DE PERSONAJE<br>PARA VALIDAR RETINA</p>
        </div>
    </div>

    <div id="mastermind-screen" class="modal">
        <h2 style="color: var(--cold-blue)">BYPASS DE SEGURIDAD</h2>
        <div id="mm-display" style="font-size: 2rem; border: 1px dashed var(--cold-blue); padding: 10px; width: 150px; text-align: center;">---</div>
        <div class="numpad">
            <button class="num-btn" onclick="pressNum(0)">0</button>
            <button class="num-btn" onclick="pressNum(1)">1</button>
            <button class="num-btn" onclick="pressNum(2)">2</button>
            <button class="num-btn" onclick="pressNum(3)">3</button>
            <button class="num-btn" onclick="pressNum(4)">4</button>
            <button class="num-btn" onclick="pressNum(5)">5</button>
            <button class="num-btn" onclick="pressNum(6)">6</button>
            <button class="num-btn" onclick="pressNum(7)">7</button>
            <button class="num-btn" onclick="pressNum(8)">8</button>
            <button class="num-btn" onclick="pressNum(9)">9</button>
            <button class="num-btn" onclick="clearNum()" style="color: var(--danger-red);">X</button>
            <button class="num-btn" onclick="checkMastermind()" style="color: var(--crt-green);">OK</button>
        </div>
        <div id="mm-log" style="margin-top: 20px; font-size: 10px; color: #aaa; text-align: center;"></div>
        <button onclick="closeModal('mastermind-screen')" style="margin-top: 20px;">VOLVER</button>
    </div>

    <div id="ui-wrapper">
        <div id="header">
            <button onclick="showLogin()" style="padding: 2px 5px; font-size: 8px;">LOGOUT</button>
            <span id="header-info">ACHERON v8.0</span>
            <button class="btn-blue" onclick="openMastermind()" style="padding: 2px 5px; font-size: 8px;">BYPASS</button>
        </div>

        <div id="camera-container" style="position: relative; flex-grow: 1; overflow: hidden;">
            <div id="scan-line"></div>
            <video id="video" playsinline style="width: 100%; height: 100%; object-fit: cover; opacity: 0.5;"></video>
            <canvas id="canvas" style="display:none"></canvas>

            <div id="res-modal" class="modal">
                <h1 id="res-perc" style="font-size: 4rem; margin: 0;">0%</h1>
                <h3 id="res-type">ANÁLISIS</h3>
                <p id="res-msg"></p>
                <button onclick="closeModal('res-modal')" style="width: 150px">CERRAR</button>
            </div>

            <div id="vid-modal" class="modal">
                <video id="p-video" style="width: 100%; max-height: 70%; border: 1px solid var(--cold-blue);"></video>
                <button onclick="stopVideo()" style="margin-top: 20px; width: 150px">CERRAR BIO-LOG</button>
            </div>
        </div>

        <div id="terminal-output">> SISTEMA LISTO.</div>

        <div class="btn-group">
            <button onclick="setMode('NEURONAL')">SCAN NEURONAL</button>
            <button onclick="setMode('EM')">SCAN ELECTROMAG.</button>
            <button onclick="setMode('MUTAGENO')">SCAN MUTÁGENO</button>
            <button id="btn-bio" class="btn-blue" onclick="playBioLog()" style="grid-column: span 3; display: none;">VER BIO-LOG (MP4)</button>
        </div>
    </div>

<script>
    let setupDone = false;
    let scanMode = 'ID';
    let isProcessing = false;
    let consolesFound = [];
    let currentPlayer = null;
    let currentGuess = "";
    
    let game = JSON.parse(localStorage.getItem('acheron_v8')) || {
        pass: [],
        pA: { name: "JUGADOR A", char: null, role: null, scans: {} },
        pB: { name: "JUGADOR B", char: null, role: null, scans: {} }
    };

    const v = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scanSound = new Audio('media/audio/scan.mp3');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
        v.srcObject = stream; v.play(); requestAnimationFrame(tick);
    });

    if (game.pass.length === 3) document.getElementById('btn-resume').style.display = 'block';

    function tick() {
        if (v.readyState === v.HAVE_ENOUGH_DATA && !isProcessing) {
            canvas.height = v.videoHeight; canvas.width = v.videoWidth;
            ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code && code.data.toLowerCase().startsWith("acheron_")) {
                handleQR(code.data.toLowerCase());
            }
        }
        requestAnimationFrame(tick);
    }

    function handleQR(data) {
        isProcessing = true;
        
        // FASE SETUP
        if (!setupDone && game.pass.length < 3) {
            if (data.includes("cons_") && !consolesFound.includes(data)) {
                consolesFound.push(data);
                document.getElementById('setup-progress').innerText = consolesFound.length + "/3";
                if (consolesFound.length === 3) {
                    game.pass = consolesFound.map(c => c.split('_').pop());
                    document.getElementById('btn-start-game').style.display = 'block';
                    save();
                }
            }
            setTimeout(() => isProcessing = false, 1500);
            return;
        }

        // FASE LOGIN (Identificación)
        if (currentPlayer && !game[currentPlayer].char) {
            if (data.includes("char_")) {
                game[currentPlayer].char = data.replace("acheron_char_", "");
                assignRole(game[currentPlayer]);
                save();
                enterShip();
            }
            setTimeout(() => isProcessing = false, 1500);
            return;
        }

        // FASE JUEGO (Escaneo)
        if (data.includes("char_")) {
            let charScanned = data.replace("acheron_char_", "");
            if (charScanned === game[currentPlayer].char) {
                if (scanMode !== 'ID') runAnalysis(game[currentPlayer]);
                else {
                    document.getElementById('btn-bio').style.display = 'block';
                    isProcessing = false;
                }
            } else {
                alert("ERROR: RETINA NO COINCIDE CON EL USUARIO ACTUAL.");
                isProcessing = false;
            }
        }
    }

    // --- LÓGICA DE NAVEGACIÓN ---
    function resumeGame() { setupDone = true; document.getElementById('start-screen').style.display = 'none'; showLogin(); }
    function hardReset() { 
        if(confirm("¿INICIAR NUEVA MISIÓN?")) { 
            localStorage.removeItem('acheron_v8'); 
            location.reload(); 
        } 
    }
    function showLogin() {
        setupDone = true;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('player-selector').style.display = 'block';
        document.getElementById('verify-zone').style.display = 'none';
        document.getElementById('name-input-zone').style.display = 'none';
    }
    function selectPlayer(p) {
        currentPlayer = p === 'A' ? 'pA' : 'pB';
        if (game[currentPlayer].name.startsWith("JUGADOR")) {
            document.getElementById('player-selector').style.display = 'none';
            document.getElementById('name-input-zone').style.display = 'block';
        } else if (!game[currentPlayer].char) {
            document.getElementById('player-selector').style.display = 'none';
            document.getElementById('verify-zone').style.display = 'block';
            isProcessing = false;
        } else {
            enterShip();
        }
    }
    function saveName() {
        let n = document.getElementById('player-name-field').value;
        if (n) {
            game[currentPlayer].name = n;
            save();
            selectPlayer(currentPlayer === 'pA' ? 'A' : 'B');
        }
    }
    function enterShip() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('header-info').innerText = game[currentPlayer].name;
        document.getElementById('bg-char').src = `media/images/${game[currentPlayer].char}.jpg`;
        document.getElementById('terminal-output').innerText = "> BIENVENIDO, " + game[currentPlayer].name;
        isProcessing = false;
    }

    // --- LÓGICA MASTERMIND ---
    function openMastermind() { document.getElementById('mastermind-screen').style.display = 'flex'; }
    function pressNum(n) { if(currentGuess.length < 3) { currentGuess += n; document.getElementById('mm-display').innerText = currentGuess; } }
    function clearNum() { currentGuess = ""; document.getElementById('mm-display').innerText = "---"; }
    function checkMastermind() {
        if(currentGuess.length < 3) return;
        let secret = game.pass;
        let guessArr = currentGuess.split("");
        let posMatch = 0; // Números correctos en posición correcta
        let numMatch = 0; // Números que están pero en otra posición

        // Lógica Mastermind
        let secretCopy = [...secret];
        let guessCopy = [...guessArr];

        for(let i=0; i<3; i++) {
            if(guessCopy[i] === secretCopy[i]) { posMatch++; secretCopy[i] = null; guessCopy[i] = "X"; }
        }
        for(let i=0; i<3; i++) {
            if(guessCopy[i] !== "X" && secretCopy.includes(guessCopy[i])) {
                numMatch++;
                secretCopy[secretCopy.indexOf(guessCopy[i])] = null;
            }
        }

        let resultText = `INTENTO ${currentGuess}: [${posMatch} BLOQUEOS] [${numMatch} FIRMAS]`;
        if (posMatch === 3) resultText = "SISTEMA DESBLOQUEADO. ¡VICTORIA!";
        
        document.getElementById('mm-log').innerHTML = resultText + "<br>" + document.getElementById('mm-log').innerHTML;
        clearNum();
    }

    // --- OTROS ---
    function runAnalysis(player) {
        scanSound.play().catch(()=>{});
        const line = document.getElementById('scan-line');
        line.style.display = 'block';
        line.style.animation = 'moveScan 2s linear 1';
        setTimeout(() => {
            line.style.display = 'none';
            document.getElementById('res-modal').style.display = 'flex';
            let match = (scanMode === 'NEURONAL' && player.role === 'HUMANO') || (scanMode === 'EM' && player.role === 'CYBORG') || (scanMode === 'MUTAGENO' && player.role === 'ADAPTOID');
            let p = (player.scans[scanMode] || 0) === 0 ? (match ? r(50,75) : r(0,5)) : (match ? r(90,99) : r(5,15));
            document.getElementById('res-perc').innerText = p + "%";
            document.getElementById('res-msg').innerText = p > 80 ? "FIRMA POSITIVA" : "DATOS INSUFICIENTES";
            player.scans[scanMode] = (player.scans[scanMode] || 0) + 1;
            save();
        }, 2000);
    }
    function playBioLog() {
        let p = game[currentPlayer];
        const vid = document.getElementById('p-video');
        vid.src = `media/videos/${p.char}.mp4`;
        document.getElementById('vid-modal').style.display = 'flex';
        vid.play();
    }
    function stopVideo() { document.getElementById('p-video').pause(); closeModal('vid-modal'); }
    function setMode(m) { scanMode = m; document.getElementById('terminal-output').innerText = "> MODO: " + m; }
    function save() { localStorage.setItem('acheron_v8', JSON.stringify(game)); }
    function r(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; isProcessing = false; scanMode = 'ID'; }
    function assignRole(player) {
        let roles = ['HUMANO', 'CYBORG', 'ADAPTOID'];
        player.role = roles[r(0,2)];
    }
</script>
</body>
</html>
